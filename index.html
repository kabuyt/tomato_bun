<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>„Éà„Éû„Éà „Å∂„Çì„ÅΩ„ÅÜ N5</title>
    <style>
        body { 
            font-family: 'Hiragino Kaku Gothic ProN', Arial, sans-serif; 
            text-align: center; 
            background: #FFF9E6; 
            color: #444; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header { padding: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logo { font-size: 30px; }
        .progress-bar-bg { width: 100%; max-width: 300px; height: 10px; background: #E0E0E0; border-radius: 5px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: #66BB6A; width: 0%; transition: width 0.3s; }

        /* „É°„Ç§„É≥„Ç®„É™„Ç¢ */
        #game-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            max-width: 500px; 
            margin: 0 auto; 
            width: 100%; 
            box-sizing: border-box;
        }

        /* Ë≥™Âïè */
        .question-box { margin-bottom: 20px; }
        .question-text { font-size: 22px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .question-hint { color: #888; font-size: 14px; }
        .tomato-mascot { font-size: 60px; margin-bottom: 10px; display:block; animation: float 3s ease-in-out infinite; }

        /* Ëß£Á≠î„Ç®„É™„Ç¢Ôºà‰∏ä„ÅÆÊÆµÔºâ */
        .answer-area { 
            min-height: 80px; 
            border-bottom: 3px solid #FFCC80; 
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 10px; 
            justify-content: center;
            align-items: center;
        }
        .placeholder { color: #aaa; font-size: 14px; }

        /* ÈÅ∏ÊäûËÇ¢„Ç®„É™„Ç¢Ôºà‰∏ã„ÅÆÊÆµÔºâ */
        .choices-area { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            justify-content: center; 
            align-content: flex-start;
            flex: 1; /* ÊÆã„Çä„ÅÆ„Çπ„Éö„Éº„Çπ„Çí‰Ωø„ÅÜ */
        }

        /* ÂçòË™û„Éñ„É≠„ÉÉ„ÇØ */
        .word-block {
            background: white;
            border: 2px solid #ddd;
            border-bottom: 5px solid #ddd;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 18px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            transition: all 0.1s;
        }
        .word-block:active {
            transform: translateY(4px);
            border-bottom: 2px solid #ddd;
        }
        /* ÈÅ∏„Çì„Å†„ÅÇ„Å®„ÅÆË¶ã„ÅüÁõÆ */
        .word-in-answer {
            background: #fff;
            border-color: #FFCDD2;
            border-bottom-color: #EF5350;
            color: #FF5252;
        }

        /* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„Çø„É≥ */
        .check-btn {
            margin-top: 10px;
            padding: 18px;
            background: #ccc;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            width: 100%;
            cursor: pointer;
            pointer-events: none; 
        }
        .check-btn.active {
            background: #66BB6A;
            box-shadow: 0 4px 0 #388E3C;
            cursor: pointer;
            pointer-events: auto;
        }
        .check-btn.active:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* ÁµêÊûúÁîªÈù¢Ôºà‰∏ã„Åã„ÇâÂá∫„Å¶„Åè„ÇãÔºâ */
        .feedback-overlay {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 25px; 
            border-radius: 20px 20px 0 0;
            transform: translateY(110%);
            transition: transform 0.3s;
            text-align: left;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .feedback-overlay.show { transform: translateY(0); }
        .feedback-correct { background: #d7ffb8; color: #2e7d32; border-top: 5px solid #2e7d32; }
        .feedback-wrong { background: #ffcdd2; color: #c62828; border-top: 5px solid #c62828; }
        
        .next-btn {
            float: right;
            padding: 12px 30px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-correct { background: #66BB6A; color: white; box-shadow: 0 4px 0 #2E7D32; }
        .btn-wrong { background: #E53935; color: white; box-shadow: 0 4px 0 #B71C1C; }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    </style>
</head>
<body>

    <header>
        <span class="logo">üçÖ</span>
        <div class="progress-bar-bg"><div id="progress-bar" class="progress-bar-fill"></div></div>
    </header>

    <div id="game-area">
        <div class="question-box">
            <div class="tomato-mascot" id="mascot">ü§î</div>
            <div class="question-text" id="q-text">Loading...</div>
            <div class="question-hint">„Åü„Å†„Åó„ÅÑ „Åò„ÇÖ„Çì„Å∞„Çì„Å´ „Å™„Çâ„Åπ„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>

        <div class="answer-area" id="answer-slot">
            <span class="placeholder">„Åì„Åì„Çí „Çø„ÉÉ„Éó „Åó„Å¶„Å≠</span>
        </div>

        <div class="choices-area" id="choices-slot"></div>

        <button id="check-btn" class="check-btn" onclick="checkAnswer()">„ÉÅ„Çß„ÉÉ„ÇØ (Ki·ªÉm tra)</button>
    </div>

    <div id="feedback" class="feedback-overlay">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <strong id="feedback-title" style="font-size:20px; display:block; margin-bottom:5px;"></strong>
                <span id="feedback-msg" style="font-size:16px;"></span>
            </div>
            <button id="next-btn" class="next-btn" onclick="nextQuestion()">„Å§„Åé„Å∏</button>
        </div>
    </div>

    <script>
        // ‚òÖ ÊñáÊ≥ï„Éá„Éº„ÇøÔºàÂÖ®ÈÉ®„Å≤„Çâ„Åå„Å™ÔºÅÔºâ
        const grammarData = [
            {
                meaning: "„Çè„Åü„Åó„ÅØ „Åå„Åè„Åõ„ÅÑ „Åß„Åô„ÄÇ",
                v_meaning: "T√¥i l√† h·ªçc sinh.",
                parts: ["„Çè„Åü„Åó", "„ÅØ", "„Åå„Åè„Åõ„ÅÑ", "„Åß„Åô"],
                extras: ["„ÅÇ„Å™„Åü", "„Å´"], // „ÉÄ„Éü„Éº
                comment: "A „ÅØ B „Åß„Åô = A l√† B"
            },
            {
                meaning: "„Åì„Çå„ÅØ „Å™„Çì„Åß„Åô„Åã„ÄÇ",
                v_meaning: "C√°i n√†y l√† c√°i g√¨?",
                parts: ["„Åì„Çå", "„ÅØ", "„Å™„Çì", "„Åß„Åô", "„Åã"],
                extras: ["„Å©„Çå", "„Çí"],
                comment: "„Åã = ? („Åó„Å§„ÇÇ„Çì)"
            },
            {
                meaning: "„Çä„Çì„Åî„Çí „Åü„Åπ„Åæ„Åô„ÄÇ",
                v_meaning: "T√¥i ƒÉn t√°o.",
                parts: ["„Çä„Çì„Åî", "„Çí", "„Åü„Åπ„Åæ„Åô"],
                extras: ["„ÅÆ„Åø„Åæ„Åô", "„Åß", "„ÅØ"],
                comment: "O + „Çí + V („Å©„ÅÜ„Åó)"
            },
            {
                meaning: "„ÅÇ„Åó„Åü „Åå„Å£„Åì„ÅÜ„Å∏ „ÅÑ„Åç„Åæ„Åô„ÄÇ",
                v_meaning: "Ng√†y mai t√¥i ƒëi ƒë·∫øn tr∆∞·ªùng.",
                parts: ["„ÅÇ„Åó„Åü", "„Åå„Å£„Åì„ÅÜ", "„Å∏", "„ÅÑ„Åç„Åæ„Åô"],
                extras: ["„Å´", "„Åç„Åæ„Åô", "„Åß"],
                comment: "„Å∏ (e) = „Åª„ÅÜ„Åì„ÅÜ (ph∆∞∆°ng h∆∞·ªõng)"
            },
            {
                meaning: "„Å®„Åó„Çá„Åã„Çì„Åß „Åπ„Çì„Åç„Çá„ÅÜ „Åó„Åæ„Åô„ÄÇ",
                v_meaning: "T√¥i h·ªçc ·ªü th∆∞ vi·ªán.",
                parts: ["„Å®„Åó„Çá„Åã„Çì", "„Åß", "„Åπ„Çì„Åç„Çá„ÅÜ", "„Åó„Åæ„Åô"],
                extras: ["„Å´", "„Çí", "„Å∏"],
                comment: "„Å∞„Åó„Çá + „Åß + „Ç¢„ÇØ„Ç∑„Éß„É≥"
            },
            {
                meaning: "„Ç≥„Éº„Éí„Éº„Çí „ÅÆ„Åø„Åæ„Åõ„Çì„Åã„ÄÇ",
                v_meaning: "B·∫°n c√≥ mu·ªën u·ªëng c√† ph√™ kh√¥ng?",
                parts: ["„Ç≥„Éº„Éí„Éº", "„Çí", "„ÅÆ„Åø„Åæ„Åõ„Çì", "„Åã"],
                extras: ["„ÅÆ„Åø„Åæ„Åô", "„ÅØ"],
                comment: "ÔΩû„Åæ„Åõ„Çì„Åã = „Åä„Åï„Åù„ÅÑ (M·ªùi m·ªçc)"
            },
            {
                meaning: "„Åì„Åì„Å´ „Å™„Åæ„Åà„Çí „Åã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                v_meaning: "H√£y vi·∫øt t√™n v√†o ƒë√¢y.",
                parts: ["„Åì„Åì", "„Å´", "„Å™„Åæ„Åà", "„Çí", "„Åã„ÅÑ„Å¶", "„Åè„Å†„Åï„ÅÑ"],
                extras: ["„Åß", "„Åã„Åç„Åæ„Åô"],
                comment: "ÔΩû„Å¶„Åè„Å†„Åï„ÅÑ = „Åä„Å≠„Åå„ÅÑ (Y√™u c·∫ßu)"
            },
            {
                meaning: "„Åæ„ÅÑ„Å´„Å° Ôºó„Åò„Å´ „Åä„Åç„Åæ„Åô„ÄÇ",
                v_meaning: "H√†ng ng√†y t√¥i d·∫≠y l√∫c 7 gi·ªù.",
                parts: ["„Åæ„ÅÑ„Å´„Å°", "Ôºó„Åò", "„Å´", "„Åä„Åç„Åæ„Åô"],
                extras: ["„Åß", "„Å≠„Åæ„Åô"],
                comment: "„Åò„Åã„Çì + „Å´ (V√†o l√∫c...)"
            },
            {
                meaning: "„ÅÇ„ÅÆ „Å®„Åë„ÅÑ„ÅØ „Åü„Åã„ÅÑ„Åß„Åô„ÄÇ",
                v_meaning: "C√°i ƒë·ªìng h·ªì kia ƒë·∫Øt.",
                parts: ["„ÅÇ„ÅÆ", "„Å®„Åë„ÅÑ", "„ÅØ", "„Åü„Åã„ÅÑ", "„Åß„Åô"],
                extras: ["„Åù„ÅÆ", "„Åü„Åã„Åè", "„ÅÇ„Çã"],
                comment: "„Åë„ÅÑ„Çà„ÅÜ„Åó (T√≠nh t·ª´) + „Åß„Åô"
            },
            {
                meaning: "„Å´„Å°„Çà„ÅÜ„Å≥ „Å™„Å´„Çí „Åó„Åæ„Åó„Åü„Åã„ÄÇ",
                v_meaning: "Ch·ªß nh·∫≠t b·∫°n ƒë√£ l√†m g√¨?",
                parts: ["„Å´„Å°„Çà„ÅÜ„Å≥", "„Å™„Å´", "„Çí", "„Åó„Åæ„Åó„Åü", "„Åã"],
                extras: ["„Åó„Åæ„Åô", "„Åß", "„Å™„Çì"],
                comment: "„Åó„Åæ„Åó„Åü = „Åã„Åì„Åë„ÅÑ (Qu√° kh·ª©)"
            }
        ];

        let currentIndex = 0;
        let currentSelection = []; 
        let currentQuestion = {};
        let shuffledChoices = [];  

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„Å´„Çπ„Çø„Éº„Éà
        window.onload = initGame;

        function initGame() {
            currentIndex = 0;
            loadQuestion();
        }

        function loadQuestion() {
            // „É™„Çª„ÉÉ„Éà
            currentSelection = [];
            document.getElementById('feedback').classList.remove('show');
            document.getElementById('check-btn').classList.remove('active');
            document.getElementById('mascot').innerText = "ü§î";
            
            if (currentIndex >= grammarData.length) {
                finishGame();
                return;
            }

            currentQuestion = grammarData[currentIndex];
            // „Éô„Éà„Éä„É†Ë™û„ÅÆÊÑèÂë≥„ÇíË°®Á§∫
            document.getElementById('q-text').innerText = currentQuestion.v_meaning;
            
            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº
            const pct = (currentIndex / grammarData.length) * 100;
            document.getElementById('progress-bar').style.width = pct + "%";

            // Ê≠£Ëß£„Éë„Éº„ÉÑ + „ÉÄ„Éü„Éº(extras) „ÇíÊ∑∑„Åú„Çã
            const extras = currentQuestion.extras || [];
            const allParts = [...currentQuestion.parts, ...extras];

            // „Ç∑„É£„ÉÉ„Éï„É´
            shuffledChoices = allParts.sort(() => Math.random() - 0.5);
            
            renderUI();
        }

        function renderUI() {
            const answerSlot = document.getElementById('answer-slot');
            const choicesSlot = document.getElementById('choices-slot');
            
            answerSlot.innerHTML = "";
            choicesSlot.innerHTML = "";

            // 1. Ëß£Á≠î„Ç®„É™„Ç¢
            if (currentSelection.length === 0) {
                answerSlot.innerHTML = '<span class="placeholder">„Åó„Åü„ÅÆ „Åü„Çì„Åî„Çí „Åà„Çâ„Çì„Åß„Å≠</span>';
            } else {
                currentSelection.forEach((word, index) => {
                    let btn = createWordBtn(word, true);
                    btn.onclick = () => removeWord(index); // „Çø„ÉÉ„Éó„ÅßÊàª„Åô
                    answerSlot.appendChild(btn);
                });
            }

            // 2. ÈÅ∏ÊäûËÇ¢„Ç®„É™„Ç¢ÔºàÊÆã„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„Å†„ÅëË°®Á§∫Ôºâ
            let counts = {};
            shuffledChoices.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
            currentSelection.forEach(x => { if(counts[x]) counts[x]--; });

            shuffledChoices.forEach(word => {
                if (counts[word] > 0) {
                    let btn = createWordBtn(word, false);
                    btn.onclick = () => addWord(word); // „Çø„ÉÉ„Éó„ÅßËøΩÂä†
                    choicesSlot.appendChild(btn);
                    counts[word]--; 
                }
            });

            // CHECK„Éú„Çø„É≥Âà∂Âæ°
            const checkBtn = document.getElementById('check-btn');
            if (currentSelection.length > 0) {
                checkBtn.classList.add('active');
            } else {
                checkBtn.classList.remove('active');
            }
        }

        function createWordBtn(text, isAnswer) {
            let btn = document.createElement('div');
            btn.className = isAnswer ? 'word-block word-in-answer' : 'word-block';
            btn.innerText = text;
            return btn;
        }

        function addWord(word) {
            speak(word); // „Çø„ÉÉ„Éó„Åó„Åü„ÇâÂ∞ë„ÅóË™≠„ÇÄ
            currentSelection.push(word);
            renderUI();
        }

        function removeWord(index) {
            currentSelection.splice(index, 1);
            renderUI();
        }

        function checkAnswer() {
            const btn = document.getElementById('check-btn');
            if (!btn.classList.contains('active')) return;

            const userAns = currentSelection.join("");
            const correctAns = currentQuestion.parts.join("");

            const feedback = document.getElementById('feedback');
            const title = document.getElementById('feedback-title');
            const msg = document.getElementById('feedback-msg');
            const nextBtn = document.getElementById('next-btn');

            feedback.className = "feedback-overlay show";

            if (userAns === correctAns) {
                // Ê≠£Ëß£
                feedback.classList.add("feedback-correct");
                feedback.classList.remove("feedback-wrong");
                title.innerText = "„Åõ„ÅÑ„Åã„ÅÑÔºÅ (ƒê√∫ng r·ªìi!)";
                msg.innerText = currentQuestion.meaning; 
                document.getElementById('mascot').innerText = "üçÖ‚ú®";
                
                speak(userAns); // ÊñáÂÖ®‰Ωì„ÇíË™≠„Åø‰∏ä„Åí
                
                nextBtn.className = "next-btn btn-correct";
            } else {
                // ‰∏çÊ≠£Ëß£
                feedback.classList.add("feedback-wrong");
                feedback.classList.remove("feedback-correct");
                title.innerText = "„Åñ„Çì„Å≠„Çì... (Sai r·ªìi)";
                msg.innerText = "„Åõ„ÅÑ„Åã„ÅÑ: " + currentQuestion.parts.join(" ") + "\nüí° " + currentQuestion.comment;
                document.getElementById('mascot').innerText = "üçÖüí¶";
                
                nextBtn.className = "next-btn btn-wrong";
            }
        }

        function nextQuestion() {
            currentIndex++;
            loadQuestion();
        }

        function finishGame() {
            document.getElementById('game-area').innerHTML = `
                <h2 style="color:#FF5252; margin-top:50px;">„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ üéâ</h2>
                <div style="font-size:80px;">üçÖ</div>
                <p>„Åú„Çì„Å∂ „Åä„Çè„Çä„Åæ„Åó„ÅüÔºÅ</p>
                <button class="check-btn active" onclick="location.reload()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å© (L√†m l·∫°i)</button>
            `;
            document.getElementById('progress-bar').style.width = "100%";
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = "ja-JP";
            uttr.rate = 0.9;
            window.speechSynthesis.speak(uttr);
        }
    </script>
</body>
</html>